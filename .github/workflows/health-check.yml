name: ğŸ¥ Health Check & Error Detection

# Monitoreo continuo cada 15 minutos
# Detecta errores y envÃ­a alertas inmediatas

on:
  schedule:
    # Cada 15 minutos
    - cron: '*/15 * * * *'
  workflow_dispatch:  # Manual

env:
  ALERT_EMAIL: 'santi@annalogica.eu'
  PRODUCTION_URL: 'https://annalogica.eu'

jobs:
  health-check:
    name: ğŸ¥ Production Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ¥ Check /api/health endpoint
        id: health_check
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PRODUCTION_URL }}/api/health)
          echo "health_status=$RESPONSE" >> $GITHUB_OUTPUT

          if [ "$RESPONSE" != "200" ]; then
            echo "::error::Health check fallÃ³ con cÃ³digo $RESPONSE"
            echo "healthy=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Health check OK (200)"
            echo "healthy=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸŒ Check homepage
        id: homepage_check
        run: |
          START_TIME=$(date +%s%3N)
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}:%{time_total}" ${{ env.PRODUCTION_URL }}/)
          END_TIME=$(date +%s%3N)

          HTTP_CODE=$(echo $RESPONSE | cut -d: -f1)
          RESPONSE_TIME=$(echo $RESPONSE | cut -d: -f2)

          echo "homepage_status=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "homepage_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Homepage fallÃ³ con cÃ³digo $HTTP_CODE"
            echo "homepage_ok=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Homepage OK (200) - ${RESPONSE_TIME}s"
            echo "homepage_ok=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” Check recent errors (via API)
        id: error_check
        run: |
          # Intentar obtener errores recientes del endpoint de admin
          # Si tienes un endpoint pÃºblico de health que devuelva error count, Ãºsalo aquÃ­
          echo "error_count=0" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Performance check
        id: performance
        run: |
          # Verificar tiempo de respuesta de varios endpoints
          declare -a ENDPOINTS=("/api/health" "/api/version" "/pricing")
          SLOW_ENDPOINTS=()

          for endpoint in "${ENDPOINTS[@]}"; do
            RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" ${{ env.PRODUCTION_URL }}$endpoint)
            echo "Endpoint $endpoint: ${RESPONSE_TIME}s"

            # Si demora mÃ¡s de 3 segundos, es lento
            if (( $(echo "$RESPONSE_TIME > 3.0" | bc -l) )); then
              SLOW_ENDPOINTS+=("$endpoint (${RESPONSE_TIME}s)")
            fi
          done

          if [ ${#SLOW_ENDPOINTS[@]} -gt 0 ]; then
            echo "::warning::Endpoints lentos detectados: ${SLOW_ENDPOINTS[*]}"
            echo "slow_endpoints=${SLOW_ENDPOINTS[*]}" >> $GITHUB_OUTPUT
            echo "performance_ok=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Performance OK - todos los endpoints <3s"
            echo "performance_ok=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸš¨ Create incident if health check failed
        if: steps.health_check.outputs.healthy == 'false' || steps.homepage_check.outputs.homepage_ok == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ğŸš¨ ALERTA: Annalogica Health Check Failed';
            const body = `
            ## ğŸš¨ INCIDENTE DE PRODUCCIÃ“N

            **Fecha:** ${new Date().toISOString()}
            **Severidad:** ALTA

            ### Estado de los Checks:
            - Health API: ${{ steps.health_check.outputs.health_status }}
            - Homepage: ${{ steps.homepage_check.outputs.homepage_status }}
            - Performance: ${{ steps.performance.outputs.performance_ok }}

            ### AcciÃ³n Requerida:
            1. Verificar logs de Vercel
            2. Revisar status de servicios externos (OpenAI, Vercel Postgres)
            3. Verificar deployment reciente

            ### Enlaces:
            - [Vercel Dashboard](https://vercel.com/solammedia-9886s-projects/annalogica)
            - [GitHub Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['incident', 'high-priority', 'production']
            });

      - name: ğŸ“§ Send alert email
        if: steps.health_check.outputs.healthy == 'false' || steps.homepage_check.outputs.homepage_ok == 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.resend.com
          server_port: 465
          secure: true
          username: resend
          password: ${{ secrets.RESEND_API_KEY }}
          subject: "ğŸš¨ ALERTA CRÃTICA: Annalogica Health Check Failed"
          to: ${{ env.ALERT_EMAIL }}
          from: Annalogica Monitoring <alerts@annalogica.eu>
          body: |
            ğŸš¨ ALERTA CRÃTICA - ACCIÃ“N INMEDIATA REQUERIDA

            Hola Santi,

            El sistema de monitoreo ha detectado un problema crÃ­tico en producciÃ³n.

            ğŸ“Š ESTADO DEL SISTEMA:
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            Health API: ${{ steps.health_check.outputs.health_status }}
            Homepage: ${{ steps.homepage_check.outputs.homepage_status }} (${{ steps.homepage_check.outputs.homepage_time }}s)
            Performance: ${{ steps.performance.outputs.performance_ok }}

            â° DETECCIÃ“N:
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

            ğŸ”— ACCIONES INMEDIATAS:
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            1. Vercel Dashboard: https://vercel.com/solammedia-9886s-projects/annalogica
            2. Logs detallados: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            3. Verificar servicios: OpenAI, Vercel Postgres, Stripe

            Este es un mensaje automÃ¡tico del sistema de monitoreo.

            ---
            Annalogica Health Monitoring System
            https://annalogica.eu

      - name: âš ï¸ Send performance warning
        if: steps.performance.outputs.performance_ok == 'false' && steps.health_check.outputs.healthy == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.resend.com
          server_port: 465
          secure: true
          username: resend
          password: ${{ secrets.RESEND_API_KEY }}
          subject: "âš ï¸ Annalogica: Performance Degradation Detected"
          to: ${{ env.ALERT_EMAIL }}
          from: Annalogica Monitoring <alerts@annalogica.eu>
          body: |
            âš ï¸ ADVERTENCIA DE PERFORMANCE

            Hola Santi,

            Se ha detectado degradaciÃ³n en el rendimiento de algunos endpoints.

            ğŸ“Š ENDPOINTS LENTOS:
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ${{ steps.performance.outputs.slow_endpoints }}

            â° DETECCIÃ“N:
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

            El sistema sigue operativo pero con tiempos de respuesta elevados (>3s).

            Considera revisar:
            - Uso de CPU/Memoria en Vercel
            - Conexiones a base de datos
            - CachÃ© y CDN

            ---
            Annalogica Performance Monitoring
